!function(){"use strict";const t=300,e=30,s=1e3,n=30,i=2,r=1,a=-2,o={level:0,wrong:0,lives:3,totalTime:t,currentTime:t,statistics:[]},c={appId:"",questions:[],statistics:[]};var l=[{artist:"Kevin MacLeod",name:"Long Stroll",image:"https://yt3.ggpht.com/-fkDeGauT7Co/AAAAAAAAAAI/AAAAAAAAAAA/dkF5ZKkrxRo/s900-c-k-no-mo-rj-c0xffffff/photo.jpg",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Kevin_MacLeod/Oddities/Kevin_MacLeod_-_Sinfonia_3.mp3",genre:"Jazz"},{artist:"Jingle Punks",name:"In the Land of Rhinoplasty",image:"https://i.vimeocdn.com/portrait/992615_300x300",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Kevin_MacLeod/Oddities/Kevin_MacLeod_-_Sing_Along_with_Jim.mp3",genre:"Rock"},{artist:"Audionautix",name:"Travel Light",image:"https://4.bp.blogspot.com/-kft9qu5ET6U/VPFUBi9W-MI/AAAAAAAACYM/UxXilXKYwOc/s1600/audionautix%2BHalf%2BSize.jpg",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Jason_Shaw/Audionautix_Acoustic/Jason_Shaw_-_TRAVEL_LIGHT.mp3",genre:"Country"},{artist:"Riot",name:"Level Plane",image:"https://yt3.ggpht.com/a/AGF-l7-BSwMnN5-kvIOxYVDXV1TRBG-G8LTRpjsHPQ=s48-c-k-c0xffffffff-no-rj-mo",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/WFMU/Steve_Combs/Riot/Steve_Combs_-_11_-_More_Or_Less_OK.mp3",genre:"R&B"},{artist:"Jingle Punks",name:"Lucky Day",image:"https://i.vimeocdn.com/portrait/992615_300x300",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Jason_Shaw/Audionautix_Acoustic/Jason_Shaw_-_SERENITY.mp3",genre:"Pop"},{artist:"Quincas Moreira",name:"Firefly",image:"https://assets.mubi.com/images/cast_member/535878/image-w240.jpg?1523578011",src:"https://files.freemusicarchive.org/storage-freemusicarchive-org/music/WFMU/Steve_Combs/Riot/Steve_Combs_-_04_-_Its_Kicking_In.mp3",genre:"Electronic"}];function m(t=0,e){const s=Math.ceil(t),n=Math.floor(e);return Math.floor(Math.random()*(n-s+1))+s}function u(t){const e=new Date;e.setTime(1e3*t);const s=e.toLocaleTimeString("en-US",{hour12:!1}).split(":");return{minuts:s[1],seconds:s[2]}}function h(t,e){const s=+t;if(isNaN(s))return e[2];return`${s} ${e[s%100>4&&s%100<20?2:[2,0,1,1,1,2][s%10<5?s%10:5]]}`}function d(t,e=!0){const s=document.querySelector(".main");e&&(s.textContent=""),s.append(t)}const _="https://dummyjson.com/products",p="https://dummyjson.com/products/1",g="https://dummyjson.com/products/add";async function v(){const t=function(t,e){const s={type:"",title:"",srcs:[],answers:[]},n={artist:"",name:"",img:"",src:"",isCorrect:!0},i=[];return t.forEach(((t,r)=>{const a=Object.assign({},s);a.type=t,a.title=e[r];const o=new Set,c=new Set;if("artist"===t){for(;c.size<3;)c.add(m(0,l.length-1));o.add(Array.from(c)[m(0,c.size-1)])}else if("genre"===t){for(;c.size<4;)c.add(m(0,l.length-1));const t=m(1,2);for(;o.size<t;)o.add(Array.from(c)[m(0,c.size-1)])}let u=[];o.forEach((t=>{u.push(l[t].src)})),a.srcs=Object.assign([],u),u=[],c.forEach((t=>{const e=Object.assign({},n);e.artist=l[t].artist,e.name=l[t].name,e.img=l[t].image,e.src=l[t].src,e.isCorrect=o.has(t),u.push(e)})),a.answers=u,i.push(a)})),i}(["artist","genre","genre","genre","artist","artist","genre","genre","artist","artist"],["Кто исполняет эту песню?","Выберите рок треки","Выберите джаз треки","Выберите РНБ треки","Кто исполняет эту песню?","Кто исполняет эту песню?","Выберите поп треки","Выберите электроник треки","Кто исполняет эту песню?","Кто исполняет эту песню?"]),e=await fetch(_,{method:"GET",redirect:"follow"});return f(e),await e.json(),t}function f(t){if(!t.ok)throw new Error}function w(t,e){const s=e.map((e=>t(e)));return Promise.all(s)}function b(t){return new Promise((function(e,s){const n=new Audio;n.addEventListener("canplaythrough",e,!1),n.addEventListener("error",s,!1),n.src=t}))}function y(t){return new Promise((function(e,s){const n=new Image;n.addEventListener("load",e,!1),n.addEventListener("error",s,!1),n.src=t}))}async function S(t){const e=function(t){const e=new Set,s=new Set;t.forEach((t=>{t.srcs.forEach((t=>e.add(t))),t.answers.forEach((t=>{e.add(t.src),s.add(t.img)}))}));const n={audio:[],image:[]};return n.audio=Array.from(e),n.image=Array.from(s),n}(t);await w(y,e.image),await w(b,e.audio)}class k{get _template(){throw new Error("Абстрактный метод возвращающий строку с разметкой представления.")}get element(){if(this._element)return this._element;let t=this._render(this._template);return t=this._bind(t),this._element=t.firstElementChild,this._element}_render(t){const e=document.createElement("div");return e.innerHTML=t,e}_bind(t){return t}}class A extends k{onStartBtnClick(){}get _template(){return'<section class="welcome">\n    <div class="welcome__logo"><img src="./img/melody-logo.png" alt="Угадай мелодию" width="186" height="83"></div>\n    <button class="welcome__button"><span class="visually-hidden">Начать игру</span></button>\n    <h2 class="welcome__rules-title">Правила игры</h2>\n    <p class="welcome__text">Правила просты:</p>\n    <ul class="welcome__rules-list">\n      <li>За 5 минут нужно ответить на все вопросы.</li>\n      <li>Можно допустить 3 ошибки.</li>\n    </ul>\n    <p class="welcome__text">Удачи!</p>\n  </section>'}_bind(t){return t.querySelector(".welcome__button").addEventListener("click",(t=>{t.preventDefault(),this.onStartBtnClick()})),t}}class E{constructor(){this._screenView=new A,this._screenView.onStartBtnClick=V.showGameLevel,this.element=this._screenView.element}}const T="timer__value--finished";class C extends k{constructor(t){super(),this.gameState=t}onBackBtnClick(){}updateTime(t){const e=this.element.querySelector(".timer__value"),s=this.element.querySelector(".timer__mins"),i=this.element.querySelector(".timer__secs");t.currentTime<=n&&!e.classList.contains(T)&&e.classList.add(T);const{minuts:r,seconds:a}=u(t.currentTime);s.textContent=r,i.textContent=a,this._updateTimeCircle(t.totalTime,t.currentTime)}get _template(){return(t=>{const{minuts:e,seconds:s}=u(t.currentTime);return`<header class="game__header">\n      <a class="game__back" href="#">\n        <span class="visually-hidden">Сыграть ещё раз</span>\n        <img class="game__logo" src="./img/melody-logo-ginger.png" alt="Угадай мелодию">\n      </a>\n\n      <svg xmlns="http://www.w3.org/2000/svg" class="timer" viewBox="0 0 780 780">\n        <circle class="timer__line" cx="390" cy="390" r="370" style="filter: url(.#blur); transform: rotate(-90deg) scaleY(-1); transform-origin: center">\n      </svg>\n\n      <div class="timer__value" xmlns="http://www.w3.org/1999/xhtml">\n        <span class="timer__mins">${e}</span>\n        <span class="timer__dots">:</span>\n        <span class="timer__secs">${s}</span>\n      </div>\n\n      <div class="game__mistakes">\n        ${new Array(t.wrong+1).join('<div class="wrong"></div>')}\n      </div>\n    </header>`})(this.gameState)}_bind(t){return t.querySelector(".game__back").addEventListener("click",(t=>{t.preventDefault(),this.onBackBtnClick()})),t}_updateTimeCircle(t,e){const s=this.element.querySelector(".timer__line"),n=Math.ceil(2*Math.PI*s.getAttribute("r")),{stroke:i,offset:r}=function(t,e){const s=Math.ceil(e);return{stroke:s,offset:Math.floor((1-t)*s)}}(e/t,n);s.style.strokeDasharray=`${i}px`,s.style.strokeDashoffset=`${r}px`}}const L="track__button--play",x="track__button--pause";class B{constructor(t){this.controlBtns=Array.from(t.querySelectorAll(".track__button")),this.audioElements=this.controlBtns.map((t=>t.parentElement.querySelector("audio"))),this._controlToAudioElement=new Map,this.controlBtns.forEach(((t,e)=>this._controlToAudioElement.set(t,this.audioElements[e]))),this._prevControlBtn=null,this._prevAudioElement=null,this.controlBtns.forEach((t=>t.addEventListener("click",(t=>{t.preventDefault(),this._onControlBtnClick(t.target)})))),this.audioElements.forEach((t=>t.addEventListener("ended",(t=>{this._onAudioTrackEnd(t.target)}))))}_onControlBtnClick(t){const e=t.closest(".track__button"),s=this._controlToAudioElement.get(e);this._prevControlBtn||(this._prevControlBtn=this.controlBtns.find((t=>t.classList.contains(x))),this._prevAudioElement=this._controlToAudioElement.get(this._prevControlBtn)),this._prevControlBtn&&this._prevControlBtn!==e&&this._prevControlBtn.classList.contains(x)&&this._pauseTrack(this._prevControlBtn,this._prevAudioElement),[this._prevControlBtn,this._prevAudioElement]=[e,s],e.classList.contains(x)?this._pauseTrack(e,s):this._playTrack(e,s)}_onAudioTrackEnd(t){const e=t,s=this.controlBtns[this.audioElements.indexOf(e)];s&&s.classList.contains(x)&&this._pauseTrack(s,e)}_playTrack(t,e){t.classList.remove(L),t.classList.add(x),e.play()}_pauseTrack(t,e){t.classList.remove(x),t.classList.add(L),e.pause()}}const $="outline: 2px solid red";class M extends k{constructor(t){super(),this.levelQuestion=t,this.trackController=new B(this.element),this._isAnswerSelected=!1}get answersSelected(){return this._answerBtns.map((t=>t.checked))}get _template(){return"artist"===this.levelQuestion.type?`<section class="game game--artist">\n  <section class="game__screen">\n    <h2 class="game__title">${(t=this.levelQuestion).title}</h2>\n    <div class="game__track">\n      <button class="track__button track__button--pause" type="button"></button>\n      <audio src=${t.srcs[0]} autoplay></audio>\n    </div>\n    <form class="game__artist">\n\n    ${t.answers.map(((t,e)=>`<div class="artist">\n      <input class="artist__input visually-hidden" type="radio" name="answer" value="${t.artist}" id="answer-${e+1}">\n      <label class="artist__name" for="answer-${e+1}">\n        <img class="artist__picture" src="${t.img}" alt="${t.artist}" style="${t.isCorrect?$:""}">\n        ${t.artist}\n      </label>\n    </div>`)).join("")}\n\n    </form>\n  </section>\n</section>`:(t=>`<section class="game game--artist">\n  <section class="game__screen">\n    <h2 class="game__title">${t.title}</h2>\n    <form class="game__tracks">\n\n      ${t.answers.map(((t,e)=>`<div class="track">\n      <button class="track__button ${0===e?"track__button--pause":"track__button--play"}" type="button"></button>\n      <div class="track__status">\n        <audio src=${t.src} ${0===e?"autoplay":""}></audio>\n      </div>\n      <div class="game__answer" style="${t.isCorrect?$:""}">\n        <input class="game__input visually-hidden" type="checkbox" name="answer" value="${t.artist}" id="answer-${e+1}">\n        <label class="game__check" for="answer-${e+1}">Отметить</label>\n      </div>\n    </div>`)).join("")}\n\n      <button class="game__submit button" type="submit" disabled>Ответить</button>\n    </form>\n  </section>\n</section>`)(this.levelQuestion);var t}onAnswerSubmit(){}_bind(t){return"artist"===this.levelQuestion.type?this._bindScreenSelectArtist(t):this._bindScreenSelectGenre(t)}_bindScreenSelectArtist(t){const e=t.querySelector(".game__artist");return this._answerBtns=[...t.querySelectorAll(".artist__input")],e.addEventListener("click",(t=>{this._answerBtns.includes(t.target)&&(this._isAnswerSelected=!0,this.onAnswerSubmit())})),e.addEventListener("submit",(t=>{this._onFormSubmit(t)})),t}_bindScreenSelectGenre(t){const e=t.querySelector(".game__tracks"),s=t.querySelector(".game__submit");return this._answerBtns=[...t.querySelectorAll(".game__input")],e.addEventListener("click",(t=>{this._answerBtns.includes(t.target)&&(this._isAnswerSelected=!!this.answersSelected.find((t=>!0===t)),s.disabled=!this._isAnswerSelected)})),e.addEventListener("submit",(t=>{this._onFormSubmit(t)})),t}_onFormSubmit(t){t.preventDefault(),this._isAnswerSelected&&this.onAnswerSubmit()}}class j extends k{onConfirm(){}onCancel(){}get _template(){return'<div class="modal__overlay">\n    <section class="modal">\n      <button class="modal__close js-close-btn" type="button"><span class="visually-hidden">Закрыть</span></button>\n      <h2 class="modal__title">Подтверждение</h2>\n      <p class="modal__text">Вы уверены что хотите начать игру заново?</p>\n      <div class="modal__buttons">\n        <button class="modal__button button js-confirm-btn">Ок</button>\n        <button class="modal__button button js-cancel-btn">Отмена</button>\n      </div>\n    </section>\n  </div>'}_bind(t){const e=t.querySelector(".js-confirm-btn"),s=t.querySelector(".js-cancel-btn"),n=t.querySelector(".js-close-btn"),i=t=>{t.stopPropagation(),t.preventDefault(),this.onCancel()};return s.addEventListener("click",i),n.addEventListener("click",i),e.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),this.onConfirm()})),t}}class R{constructor(){this.restart()}get state(){return Object.freeze(Object.assign({},this._state))}get currentLevel(){return c.questions[this._state.level]}set statistics(t){const e={answers:[],time:0};e.answers.push(t.answers),e.time=t.time,this._state.statistics.push(e)}restart(){this._state=Object.assign({},o),this._state.statistics=[]}nextLevel(){this._state.level++}hasNexLevel(){return void 0!==c.questions[this._state.level+1]}die(){this._state.wrong++}isDie(){return this._state.wrong>this._state.lives}tick(){this._state.currentTime--}hasMoreTime(){return this._state.currentTime>0}}class q{constructor(){this.model=new R,this._createController(this.model)}tick(){this.timerID=setTimeout((()=>{if(this.model.tick(),!this.model.hasMoreTime())return this.stopTimer(),void V.showStatistics(this.model);this.viewHeader.updateTime(this.model.state),this.tick()}),s)}stopTimer(){clearTimeout(this.timerID),this._levelEndTime=this.model.state.currentTime}nextLevel(){this.stopTimer();const t=function(t,e){return e.filter(((e,s)=>t[s]))}(this.viewBody.answersSelected,this.model.currentLevel.answers);this.model.statistics={answers:t,time:this._levelStartTime-this._levelEndTime},function(t,e){return void 0!==e.find(((e,s)=>e.isCorrect!==t[s]))}(this.viewBody.answersSelected,this.model.currentLevel.answers)&&this.model.die(),this._checkGameEnd()?V.showStatistics(this.model):(this.model.nextLevel(),this._createController(this.model),d(this.element))}_createController(t){this.viewBody=new M(t.currentLevel),this.viewBody.onAnswerSubmit=()=>this.nextLevel(),this.element=this.viewBody.element,this._updateHeader(),this._levelStartTime=t.state.currentTime,this.tick()}_updateHeader(){this.headerElement&&this.headerElement.remove(),this.viewHeader=new C(this.model.state),this.viewHeader.updateTime(this.model.state),this.viewHeader.onBackBtnClick=()=>this._showModalConfirm(),this.headerElement=this.viewHeader.element,this.element.prepend(this.headerElement)}_checkGameEnd(){return!this.model.hasNexLevel()||this.model.isDie()||!this.model.hasMoreTime()}_showModalConfirm(){this.modalConfirmView=new j,this.modalConfirmView.onCancel=()=>this.modalConfirmView.element.remove(),this.modalConfirmView.onConfirm=()=>z(),d(this.modalConfirmView.element,!1)}}class D extends k{constructor(t){super(),this.message=t}onRestartGame(){}get _template(){return`<section class="result">\n    <div class="result__logo"><img src="./img/melody-logo.png" alt="Угадай мелодию" width="186" height="83"></div>\n    ${this.message}\n    <button class="result__replay" type="button">Попробовать ещё раз</button>\n  </section>`}_bind(t){return t.querySelector(".result__replay").addEventListener("click",(t=>{t.preventDefault(),this.onRestartGame()})),t}}class I extends k{constructor(t="Синхронизация<br>данных!"){super(),this.message=t}get _template(){return`<div id="preload-spinner" class="spinner">${this.message}</div>`}}function G(t,e,s,n){if(t.isDie)return'<h2 class="result__title">Какая жалость!</h2>\n    <p class="result__total result__total--fail">У вас закончились все попытки. Ничего, повезёт в следующий раз!</p>';if(t.overTime)return'<h2 class="result__title">Увы и ах!</h2>\n    <p class="result__total result__total--fail">Время вышло! Вы не успели отгадать все мелодии</p>';const{minuts:i,seconds:r}=u(e.totalTime-e.currentTime),{positionInRating:a,totalUsers:o,percentRating:c}=function(t,e){const s=t.indexOf(e)+1;if(0===t.length)return{positionInRating:1,totalUsers:1,percentRating:100};const n=t.length,i=Math.round((n-s)/n*100);return{positionInRating:s,totalUsers:n,percentRating:i}}(s,n.ball);return`<h2 class="result__title">Вы настоящий меломан!</h2>\n    <p class="result__total">За ${h(i,["минуту","минуты","минут"])} и ${h(r,["секунда","секунды","секунд"])} вы набрали ${h(n.ball,["бал","балла","баллов"])} (${h(n.quickAnswer,["быстрый","быстрых","быстрых"])}), совершив ${h(e.wrong,["ошибку","ошибки","ошибок"])}</p>\n    <p class="result__text">Вы заняли ${a} место из ${o}. Это лучше чем у ${c}% игроков</p>`}function O(t,s,n){const o=t.reduce(((t,s)=>t+ +(s.time<e)),0);return{quickAnswer:o,ball:o*i+(n-o)*r+s*a}}class P{constructor(t){this.model=t}async createResultScreen(){let t;if(!this.model.hasNexLevel()&&!this.model.isDie()&&this.model.hasMoreTime())try{await this._dataSync()}catch(e){t='<h2 class="result__title">Ошибка синхронизации данных!</h2>\n    <p class="result__total result__total--fail">Проверьте сетевое соединение и нажмите "Попробовать ещё раз"</p>'}return t||(t=G({isDie:this.model.isDie(),overTime:!this.model.hasMoreTime()},this.model.state,c.statistics,this._userResult)),this.view=new D(t),this.view.onRestartGame=V.showStart,this.element=this.view.element,this}async _dataSync(){this.loadAnimationElement=(new I).element,d(this.loadAnimationElement,!1);try{const t=await async function(){c.statistics.length||(c.statistics=[11,10,9]);const t=`${p}?appId=${c.appId}`,e=await fetch(t,{method:"GET",redirect:"follow"});return f(e),await e.json(),c.statistics}();c.statistics=this._updateRatings(t),await async function(t){c.statistics=t;const e=`${g}?appId=${c.appId}`,s={answers:t};f(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(s)}))}(c.statistics)}finally{this.loadAnimationElement.remove()}}_updateRatings(t){const{statistics:e,wrong:s}=this.model.state;return this._userResult=O(e,s,e.length),function(t,e){if(t.includes(e))return t;const s=[...t],n=s[s.length-1]<e?s.findIndex((t=>t<e)):s.length;return s.splice(n,0,e),s}(t,this._userResult.ball)}}class V{static showStart(){d((new E).element)}static showGameLevel(){d((new q).element)}static showStatistics(t){(function(t){return new P(t).createResultScreen()})(t).then((t=>d(t.element)))}}class H extends k{constructor(t="Статус: 404. Пожалуйста, перезагрузите страницу."){super(),this.message=t}get _template(){return`<div class="modal__overlay">\n    <section class="modal">\n      <h2 class="modal__title">Произошла ошибка!</h2>\n      <p class="modal__text">${this.message}</p>\n    </section>\n  </div>`}}function z(){const t=(new I).element;d(t,!1),v().then((t=>(c.questions=t,c.appId=`${window.navigator.userAgent.split(" ").splice(-2,1)}_${Date.now()}`,t))).then((t=>S(t))).finally((()=>t.remove())).then((()=>V.showStart())).catch((()=>d((new H).element,!1)))}z()}();

//# sourceMappingURL=main.min.js.map
